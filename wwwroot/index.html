<!DOCTYPE html>
<html>
<head>
    <title>Enterprise NVR System</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #eee; }
        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .tab { padding: 15px 30px; cursor: pointer; border: none; background: #f8f9fa; font-size: 16px; margin-right: 2px; }
        .tab.active { background: #007cba; color: white; }
        .tab:hover { background: #e9ecef; }
        .tab.active:hover { background: #005a8b; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; background: #007cba; color: white; }
        button:hover { background: #005a8b; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .table th, .table td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        .table th { background: #f8f9fa; font-weight: bold; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 15px 0; }
        .metric-card { background: white; padding: 15px; border-radius: 6px; border: 1px solid #ddd; text-align: center; }
        .metric-value { font-size: 2em; font-weight: bold; color: #007cba; }
        .metric-label { font-size: 0.9em; color: #666; }
        .status { font-weight: bold; padding: 4px 8px; border-radius: 4px; }
        .running { background: #d4edda; color: #155724; }
        .stopped { background: #f8d7da; color: #721c24; }
        .starting { background: #fff3cd; color: #856404; }
        .healthy { color: #28a745; }
        .unhealthy { color: #dc3545; }
        
        /* Camera Management Styles */
        .camera-card { background: white; padding: 20px; margin: 15px 0; border-radius: 6px; border: 1px solid #ddd; }
        .camera-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .camera-name { font-size: 1.2em; font-weight: bold; }
        .camera-actions { display: flex; gap: 10px; }
        .camera-actions button { margin: 0 2px; padding: 6px 12px; font-size: 14px; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 80%; max-width: 600px; border-radius: 8px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-footer { text-align: right; margin-top: 20px; }
        .close { font-size: 28px; cursor: pointer; }
        .close:hover { color: #dc3545; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .form-group input[type='checkbox'] { width: auto; margin-right: 8px; }
        .empty-state { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Enterprise NVR System</h1>
            <p>Network Video Recorder Management Interface</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" id="dashboardTab">Dashboard</button>
            <button class="tab" id="camerasTab">Camera Management</button>
            <button class="tab" id="storageTab">Storage</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="section">
                <h2>System Metrics</h2>
                <div class="metrics-grid" id="metricsGrid"></div>
                <button onclick="refreshMetrics()">Refresh Metrics</button>
            </div>
            
            <div class="section">
                <h2>Stream Status</h2>
                <div id="status"></div>
                <button onclick="refreshStatus()">Refresh Status</button>
            </div>
        </div>

        <!-- Camera Management Tab -->
        <div id="cameras" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Camera Management</h2>
                    <button class="btn-success" onclick="showAddCameraModal()">Add Camera</button>
                </div>
                <div id="cameraList"></div>
            </div>
        </div>

        <!-- Storage Tab -->
        <div id="storage" class="tab-content">
            <div class="section">
                <h2>Storage Pools</h2>
                <div id="storageInfo"></div>
                <button onclick="refreshStorage()">Refresh Storage</button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Camera</h3>
                <span class="close" onclick="closeCameraModal()">&times;</span>
            </div>
            <form id="cameraForm">
                <div class="form-group">
                    <label>Camera Name:</label>
                    <input type="text" id="cameraName" required>
                </div>
                <div class="form-group">
                    <label>RTSP URL:</label>
                    <input type="text" id="rtspUrl" placeholder="rtsp://192.168.1.100:554/stream" required>
                </div>
                <div class="form-group">
                    <label>Username (optional):</label>
                    <input type="text" id="username">
                </div>
                <div class="form-group">
                    <label>Password (optional):</label>
                    <input type="password" id="password">
                </div>
                <div class="form-group">
                    <label>Storage Pool:</label>
                    <select id="storagePool"></select>
                </div>
                <div class="form-group">
                    <label>Recording Days:</label>
                    <input type="number" id="recordingDays" value="30" min="1" max="365">
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="enabled" checked> Enabled</label>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="encryptStorage" checked> Encrypt Storage</label>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeCameraModal()">Cancel</button>
                    <button type="submit" class="btn-success">Save Camera</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let cameras = [];
        let storagePools = [];
        let editingCameraId = null;

        // Tab functionality
        document.getElementById('dashboardTab').addEventListener('click', () => showTab('dashboard'));
        document.getElementById('camerasTab').addEventListener('click', () => showTab('cameras'));
        document.getElementById('storageTab').addEventListener('click', () => showTab('storage'));

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'cameras') {
                loadCameras();
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function refreshMetrics() {
            try {
                const response = await fetch('/api/nvr/metrics');
                const metrics = await response.json();
                
                const totalStorage = Object.values(metrics.storagePools).reduce((sum, pool) => sum + pool.totalSpace, 0);
                const usedStorage = Object.values(metrics.storagePools).reduce((sum, pool) => sum + (pool.totalSpace - pool.freeSpace), 0);
                
                document.getElementById('metricsGrid').innerHTML = `
                    <div class='metric-card'>
                        <div class='metric-value'>${Object.keys(metrics.activeStreams).length}</div>
                        <div class='metric-label'>Active Streams</div>
                    </div>
                    <div class='metric-card'>
                        <div class='metric-value'>${metrics.totalRecordings}</div>
                        <div class='metric-label'>Total Recordings</div>
                    </div>
                    <div class='metric-card'>
                        <div class='metric-value'>${formatBytes(usedStorage)}</div>
                        <div class='metric-label'>Storage Used</div>
                    </div>
                    <div class='metric-card'>
                        <div class='metric-value'>${metrics.cpuUsage.toFixed(1)}%</div>
                        <div class='metric-label'>CPU Usage</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error refreshing metrics:', error);
                document.getElementById('metricsGrid').innerHTML = '<div>Error loading metrics</div>';
            }
        }

        async function refreshStatus() {
            try {
                const response = await fetch('/api/nvr/status');
                const status = await response.json();
                
                let html = '<table class="table"><tr><th>Camera</th><th>Status</th><th>Last Update</th><th>Actions</th></tr>';
                
                if (Object.keys(status).length === 0) {
                    html += '<tr><td colspan="4">No cameras configured</td></tr>';
                } else {
                    for (const [id, info] of Object.entries(status)) {
                        html += `<tr>
                            <td>${info.name}</td>
                            <td><span class="status ${info.status.toLowerCase()}">${info.status}</span></td>
                            <td>${new Date(info.lastUpdate).toLocaleString()}</td>
                            <td>
                                <button class="btn-success" onclick="startCamera('${id}')">Start</button>
                                <button class="btn-danger" onclick="stopCamera('${id}')">Stop</button>
                            </td>
                        </tr>`;
                    }
                }
                html += '</table>';
                document.getElementById('status').innerHTML = html;
            } catch (error) {
                console.error('Error refreshing status:', error);
                document.getElementById('status').innerHTML = 'Error loading status';
            }
        }

        async function refreshStorage() {
            try {
                const response = await fetch('/api/nvr/storage/pools');
                const pools = await response.json();
                storagePools = pools;
                
                let html = '<table class="table"><tr><th>Name</th><th>Mount Points</th><th>Total Space</th><th>Free Space</th><th>Status</th></tr>';
                
                if (pools.length === 0) {
                    html += '<tr><td colspan="5">No storage pools found</td></tr>';
                } else {
                    pools.forEach(pool => {
                        html += `<tr>
                            <td>${pool.name}</td>
                            <td>${pool.mountPoints.join(', ')}</td>
                            <td>${formatBytes(pool.totalSpace)}</td>
                            <td>${formatBytes(pool.freeSpace)}</td>
                            <td><span class="${pool.isHealthy ? 'healthy' : 'unhealthy'}">${pool.isHealthy ? 'Healthy' : 'Unhealthy'}</span></td>
                        </tr>`;
                    });
                }
                html += '</table>';
                document.getElementById('storageInfo').innerHTML = html;
            } catch (error) {
                console.error('Error refreshing storage:', error);
                document.getElementById('storageInfo').innerHTML = 'Error loading storage';
            }
        }

        // Camera Management Functions
        async function loadCameras() {
            try {
                const response = await fetch('/api/nvr/cameras');
                cameras = await response.json();
                renderCameras();
            } catch (error) {
                console.error('Error loading cameras:', error);
                document.getElementById('cameraList').innerHTML = '<div class="empty-state">Error loading cameras</div>';
            }
        }

        function renderCameras() {
            const container = document.getElementById('cameraList');
            
            if (cameras.length === 0) {
                container.innerHTML = '<div class="empty-state">No cameras configured. Click "Add Camera" to get started.</div>';
                return;
            }

            let html = '';
            cameras.forEach(camera => {
                html += `
                    <div class='camera-card'>
                        <div class='camera-header'>
                            <div class='camera-name'>${camera.name}</div>
                            <div class='camera-actions'>
                                <button class='btn-success' onclick='startCamera("${camera.id}")'>Start</button>
                                <button class='btn-danger' onclick='stopCamera("${camera.id}")'>Stop</button>
                                <button onclick='editCamera("${camera.id}")'>Edit</button>
                                <button class='btn-danger' onclick='deleteCamera("${camera.id}")'>Delete</button>
                            </div>
                        </div>
                        <div>
                            <strong>RTSP URL:</strong> ${camera.rtspUrl}<br>
                            <strong>Status:</strong> ${camera.enabled ? 'Enabled' : 'Disabled'}<br>
                            <strong>Recording Days:</strong> ${camera.recordingDays}<br>
                            <strong>Encryption:</strong> ${camera.encryptStorage ? 'Enabled' : 'Disabled'}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showAddCameraModal() {
            editingCameraId = null;
            document.getElementById('modalTitle').textContent = 'Add Camera';
            document.getElementById('cameraForm').reset();
            document.getElementById('enabled').checked = true;
            document.getElementById('encryptStorage').checked = true;
            document.getElementById('recordingDays').value = 30;
            populateStoragePoolSelect();
            document.getElementById('cameraModal').style.display = 'block';
        }

        function editCamera(cameraId) {
            const camera = cameras.find(c => c.id === cameraId);
            if (!camera) return;
            
            editingCameraId = cameraId;
            document.getElementById('modalTitle').textContent = 'Edit Camera';
            document.getElementById('cameraName').value = camera.name;
            document.getElementById('rtspUrl').value = camera.rtspUrl;
            document.getElementById('username').value = camera.username || '';
            document.getElementById('password').value = camera.password || '';
            document.getElementById('recordingDays').value = camera.recordingDays;
            document.getElementById('enabled').checked = camera.enabled;
            document.getElementById('encryptStorage').checked = camera.encryptStorage;
            populateStoragePoolSelect();
            document.getElementById('storagePool').value = camera.storagePoolId;
            document.getElementById('cameraModal').style.display = 'block';
        }

        function populateStoragePoolSelect() {
            const select = document.getElementById('storagePool');
            select.innerHTML = '';
            storagePools.forEach(pool => {
                const option = document.createElement('option');
                option.value = pool.id;
                option.textContent = pool.name;
                select.appendChild(option);
            });
        }

        function closeCameraModal() {
            document.getElementById('cameraModal').style.display = 'none';
            editingCameraId = null;
        }

        // Camera form submission
        document.getElementById('cameraForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const cameraData = {
                name: document.getElementById('cameraName').value,
                rtspUrl: document.getElementById('rtspUrl').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                storagePoolId: document.getElementById('storagePool').value,
                recordingDays: parseInt(document.getElementById('recordingDays').value),
                enabled: document.getElementById('enabled').checked,
                encryptStorage: document.getElementById('encryptStorage').checked
            };

            try {
                let response;
                if (editingCameraId) {
                    response = await fetch(`/api/nvr/cameras/${editingCameraId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cameraData)
                    });
                } else {
                    response = await fetch('/api/nvr/cameras', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cameraData)
                    });
                }

                if (response.ok) {
                    closeCameraModal();
                    loadCameras();
                    refreshStatus(); // Refresh dashboard status
                    alert(editingCameraId ? 'Camera updated successfully' : 'Camera added successfully');
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error saving camera:', error);
                alert('Error saving camera');
            }
        });

        async function deleteCamera(cameraId) {
            if (!confirm('Are you sure you want to delete this camera?')) return;
            
            try {
                const response = await fetch(`/api/nvr/cameras/${cameraId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadCameras();
                    refreshStatus(); // Refresh dashboard status
                    alert('Camera deleted successfully');
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error deleting camera:', error);
                alert('Error deleting camera');
            }
        }

        async function startCamera(cameraId) {
            try {
                const response = await fetch(`/api/nvr/camera/${cameraId}/start`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    refreshStatus();
                    alert('Camera started successfully');
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error starting camera:', error);
                alert('Error starting camera');
            }
        }

        async function stopCamera(cameraId) {
            try {
                const response = await fetch(`/api/nvr/camera/${cameraId}/stop`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    refreshStatus();
                    alert('Camera stopped successfully');
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error stopping camera:', error);
                alert('Error stopping camera');
            }
        }

        // Close modal when clicking outside
        document.getElementById('cameraModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCameraModal();
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshMetrics();
            refreshStatus();
            refreshStorage();
            
            // Auto-refresh
            setInterval(refreshMetrics, 10000);
            setInterval(refreshStatus, 30000);
            setInterval(refreshStorage, 60000);
        });
    </script>
</body>
</html>